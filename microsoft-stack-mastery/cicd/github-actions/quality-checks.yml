name: Quality Checks

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  JAVA_VERSION: '17'

jobs:
  # Security scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install safety bandit semgrep

      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json || true
        continue-on-error: true

      - name: Run Bandit security linter
        run: |
          bandit -r . -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Run Semgrep
        run: |
          semgrep --config auto --json --output semgrep-report.json . || true
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
            semgrep-report.json
            trivy-results.sarif
          retention-days: 30

  # Secret scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Dependency review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  # Python linting
  python-lint:
    name: Python Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install black flake8 pylint mypy isort
          pip install -r requirements.txt

      - name: Run Black
        run: |
          black --check --diff . > black-report.txt || true
        continue-on-error: true

      - name: Run Flake8
        run: |
          flake8 . --max-line-length=100 \
            --exclude=.git,__pycache__,venv \
            --format=json --output-file=flake8-report.json \
            --exit-zero

      - name: Run Pylint
        run: |
          pylint **/*.py \
            --exit-zero \
            --output-format=json:pylint-report.json,text:pylint-report.txt || true

      - name: Run MyPy
        run: |
          mypy . \
            --ignore-missing-imports \
            --no-strict-optional \
            --junit-xml mypy-report.xml || true
        continue-on-error: true

      - name: Run isort
        run: |
          isort --check-only --diff . > isort-report.txt || true
        continue-on-error: true

      - name: Upload lint reports
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-reports
          path: |
            black-report.txt
            flake8-report.json
            pylint-report.json
            pylint-report.txt
            mypy-report.xml
            isort-report.txt
          retention-days: 7

  # Java code quality
  java-quality:
    name: Java Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Run Checkstyle
        run: |
          mvn checkstyle:checkstyle || true
        continue-on-error: true

      - name: Run PMD
        run: |
          mvn pmd:pmd || true
        continue-on-error: true

      - name: Run SpotBugs
        run: |
          mvn spotbugs:spotbugs || true
        continue-on-error: true

      - name: Upload Java quality reports
        uses: actions/upload-artifact@v4
        with:
          name: java-quality-reports
          path: |
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
          retention-days: 7
        if: always()

  # SonarCloud Analysis
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Python tests with coverage
        run: |
          pytest tests/unit/ --cov=. --cov-report=xml --cov-report=html || true
        continue-on-error: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Build and analyze with SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=microsoft-stack-mastery \
            -Dsonar.organization=${{ secrets.SONAR_ORG }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.python.coverage.reportPaths=coverage.xml \
            -Dsonar.exclusions=**/tests/**,**/venv/**,**/__pycache__/** || true
        continue-on-error: true

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      matrix:
        language: ['python', 'java']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # License compliance
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: pip install pip-licenses

      - name: Check Python licenses
        run: |
          pip install -r requirements.txt
          pip-licenses --format=json --output-file=python-licenses.json
          pip-licenses --format=markdown --output-file=python-licenses.md

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Check Java licenses
        run: |
          mvn license:aggregate-third-party-report || true
        continue-on-error: true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            python-licenses.json
            python-licenses.md
            target/site/aggregate-third-party-report.html
          retention-days: 30

  # Test coverage
  coverage-report:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage

      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=. --cov-report=xml --cov-report=html --cov-report=term

      - name: Generate coverage badge
        run: |
          coverage report
          coverage html

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Coverage comment
        uses: py-cov-action/python-coverage-comment-action@v3
        if: github.event_name == 'pull_request'
        with:
          GITHUB_TOKEN: ${{ github.token }}

  # Quality gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs:
      - security-scan
      - python-lint
      - java-quality
      - coverage-report
    steps:
      - name: Check quality status
        run: |
          echo "All quality checks completed"
          echo "Review the artifacts for detailed reports"

      - name: Post summary
        run: |
          echo "### Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Python Lint: ${{ needs.python-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Java Quality: ${{ needs.java-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Coverage Report: ${{ needs.coverage-report.result }}" >> $GITHUB_STEP_SUMMARY
