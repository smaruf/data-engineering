trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
      - release/*
  paths:
    exclude:
      - README.md
      - docs/**
      - .gitignore

pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

variables:
  - group: azure-credentials
  - group: fabric-credentials
  - name: pythonVersion
    value: '3.11'
  - name: javaVersion
    value: '17'
  - name: mavenOptions
    value: '-Dmaven.repo.local=$(Pipeline.Workspace)/.m2/repository'
  - name: buildConfiguration
    value: 'Release'

pool:
  vmImage: 'ubuntu-latest'

stages:
  # Include stage definitions
  - template: build-pipeline.yml
  - template: test-pipeline.yml
  - template: deploy-pipeline.yml

  # Notification stage
  - stage: Notification
    displayName: 'Send Notifications'
    dependsOn:
      - Build
      - Test
      - Deploy_Dev
    condition: always()
    jobs:
      - job: NotifyTeams
        displayName: 'Notify Microsoft Teams'
        steps:
          - task: PowerShell@2
            displayName: 'Send Teams Notification'
            inputs:
              targetType: 'inline'
              script: |
                $status = "$(Agent.JobStatus)"
                $buildNumber = "$(Build.BuildNumber)"
                $sourceBranch = "$(Build.SourceBranch)"
                
                $webhookUrl = "$(TEAMS_WEBHOOK_URL)"
                
                $body = @{
                  "@type" = "MessageCard"
                  "@context" = "https://schema.org/extensions"
                  "summary" = "Build $status"
                  "themeColor" = if ($status -eq "Succeeded") { "00FF00" } else { "FF0000" }
                  "title" = "Microsoft Stack Mastery - Build $status"
                  "sections" = @(
                    @{
                      "activityTitle" = "Build $buildNumber"
                      "facts" = @(
                        @{
                          "name" = "Status"
                          "value" = $status
                        },
                        @{
                          "name" = "Branch"
                          "value" = $sourceBranch
                        },
                        @{
                          "name" = "Requested by"
                          "value" = "$(Build.RequestedFor)"
                        }
                      )
                    }
                  )
                  "potentialAction" = @(
                    @{
                      "@type" = "OpenUri"
                      "name" = "View Build"
                      "targets" = @(
                        @{
                          "os" = "default"
                          "uri" = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                        }
                      )
                    }
                  )
                } | ConvertTo-Json -Depth 10
                
                if ($webhookUrl) {
                  Invoke-RestMethod -Method Post -Uri $webhookUrl -Body $body -ContentType 'application/json'
                }
            condition: always()

      - job: NotifyEmail
        displayName: 'Send Email Notification'
        condition: failed()
        steps:
          - task: SendEmail@1
            displayName: 'Send failure notification'
            inputs:
              To: '$(NOTIFICATION_EMAIL)'
              From: 'azure-pipelines@company.com'
              Subject: 'Build $(Build.BuildNumber) Failed'
              Body: |
                Build $(Build.BuildNumber) has failed.
                
                Branch: $(Build.SourceBranch)
                Commit: $(Build.SourceVersion)
                Requested by: $(Build.RequestedFor)
                
                View build: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)
